---
title: "dreval"
author: "Charlotte Soneson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dreval}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: dreval.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    eval = FALSE,
    comment = "#>"
)
```

```{r setup}
library(dreval)
```

# Introduction

The `dreval` package provides functionality to evaluate and compare several
reduced dimension representations, in terms of how well they retain structure
from the original, high-dimensional data set. Here, we illustrate its
application to a single-cell RNA-seq data set of peripheral blood mononuclear
cells (PBMCs), which was obtained from the `TENxPBMCData` package and processed
as described in `scripts/prepare-pbmc3ksub.R`.

```{r}
data(pbmc3ksub)
```

# Evaluation

Next, we use the `dreval` function to calculate several metrics comparing each
of the reduced dimension representations in the `SingleCellExperiment` object to
the underlying data. For a list of the calculated metrics, see the help page for
`dreval()`.

```{r}
dreval(sce = pbmc3ksub, assay = "logcounts", dimReds = NULL, 
       nSamples = NULL, kTM = c(25, 100), verbose = FALSE)
```

# Computational efficiency

`dreval` relies heavily on the calculation of pairwise distances among samples,
and thus is computationally demanding for large data sets. The `dreval` function
allows for subsampling a smaller number of samples, as well as a selection of a
subset of the variables, to speed up calculations and reduce the memory
footprint. Here we investigate the stability of the calculated metrics as
decreasing number of samples are selected.

```{r}
suppressPackageStartupMessages({
    library(dplyr)
    library(tidyr)
    library(ggplot2)
})

set.seed(1)
nS <- c(100, 250, 500, 1000, 1250, 1500, 2000, 2700)
nR <- 3
v <- lapply(nS, function(n) {
    lapply(1:nR, function(i) {
        message(n, " samples, replicate ", i)
        dreval(sce = pbmc3ksub, assay = "logcounts", dimReds = NULL,
               nSamples = n, kTM = c(25, 100), verbose = FALSE) %>%
            dplyr::mutate(nSamples = n, replicate = i)
    })
})
vv <- do.call(dplyr::bind_rows, v)

vv <- vv %>% tidyr::gather(key = "measure", value = "value", 
                           -Method, -dimensionality, -nSamples, -replicate)


ggplot(vv, aes(x = nSamples, y = value, color = Method)) + 
    geom_point(size = 3) + facet_wrap(~ measure, scales = "free_y") + 
    geom_smooth(se = FALSE) + theme_bw()
```

# Session info

```{r}
sessionInfo()
```

# References
